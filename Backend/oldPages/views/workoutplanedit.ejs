<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymRats - Edit Workout Plan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/workout_plans/workoutplan_edit.css" />
    <style>
        /* Exercise selection improvements */
        .exercise-select-details {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .exercise-select-details small {
            font-size: 0.75em;
            color: #888;
        }

        .no-exercises {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* Current week indicator */
        .current-week-indicator {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #8A2BE2;
        }

        .current-week-indicator h3 {
            margin: 0;
            color: #8A2BE2;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="main-navbar">
        <header>
            <div class="brand-logo">
                <a href="/trainer" class="brand-name">GymRats</a>
            </div>
            <div class="nav-menu">
                <a href="/trainer">Home</a>
            </div>
            <div class="right-container">
                <div class="login-button">
                    <a href="/trainer_login">Logout</a>
                </div>
            </div>
            <div class="mobile-menu-icon" id="menuIcon">
                <img src="/trainer/menu.jpg" alt="Menu" height="25px" />
            </div>
        </header>
    </div>

    <!-- Mobile Side Navigation -->
    <div class="mobile-sidebar" id="sideNavbar">
        <a href="javascript:void(0)" class="close-button" id="closeBtn">×</a>
        <a href="/trainer">Home</a>
        <a href="/trainer_login">Logout</a>
    </div>
        
    </div>
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <h1>Edit Workout Plan: <span id="clientNameDisplay"><%= name %></span></h1>
            <p>Create a personalized weekly workout schedule for your client</p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Workout Plan Editor Form -->
        <div class="workout-plan-container">
            <div class="workout-plan-header">
                <button class="back-btn" onclick="window.location.href='/trainer'"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <div class="plan-info">
                    <h2>Weekly Workout Schedule</h2>
                    <p>Client: <strong><%= name %></strong> | Goal: <strong><%= goal || 'Strength Training' %></strong></p>
                </div>
            </div>

            <form id="workoutPlanForm" class="workout-plan-form">
                <input type="hidden" id="clientId" name="clientId" value="<%= id %>">
                
                <!-- Current Week Indicator -->
                <div class="current-week-indicator">
                    <h3>Current Week Workout Plan</h3>
                </div>
                
                <!-- Days of the Week Container -->
                <div class="days-container" id="daysContainer">
                    <% const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']; %>
                    <% days.forEach((day, index) => { %>
                        <div class="day-card" id="day-<%= index %>">
                            <div class="day-header">
                                <h3><%= day %></h3>
                                <div class="day-actions">
                                    <button type="button" class="add-exercise-btn" data-day="<%= index %>"><i class="fas fa-plus"></i> Add</button>
                                    <button type="button" class="rest-day-btn" data-day="<%= index %>"><i class="fas fa-moon"></i> Rest</button>
                                </div>
                            </div>
                            
                            <div class="exercises-list" id="exercises-day-<%= index %>">
                                <% if (workoutPlan && workoutPlan[day] && workoutPlan[day].length > 0) { %>
                                    <% workoutPlan[day].forEach((exercise, exIndex) => { %>
                                        <div class="exercise-item">
                                            <div class="exercise-details">
                                                <input type="text" name="currentWeek[<%= day %>][<%= exIndex %>][name]" class="exercise-name-input" value="<%= exercise.name %>" placeholder="Exercise name">
                                                <div class="exercise-params">
                                                    <input type="text" name="currentWeek[<%= day %>][<%= exIndex %>][sets]" class="sets-input" value="<%= exercise.sets %>" placeholder="Sets">
                                                    <input type="text" name="currentWeek[<%= day %>][<%= exIndex %>][reps]" class="reps-input" value="<%= exercise.reps %>" placeholder="Reps">
                                                    <input type="text" name="currentWeek[<%= day %>][<%= exIndex %>][weight]" class="weight-input" value="<%= exercise.weight %>" placeholder="Weight">
                                                </div>
                                            </div>
                                            <button type="button" class="remove-exercise-btn"><i class="fas fa-trash"></i></button>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div class="rest-day-message"><i class="fas fa-moon"></i> Rest Day</div>
                                <% } %>
                            </div>
                        </div>
                    <% }) %>
                </div>
                
                <!-- Notes Section -->
                <div class="notes-section">
                    <h3>Additional Notes</h3>
                    <textarea id="plan-notes" name="plan-notes" placeholder="Add any additional instructions or notes for the client..."><%= notes || '' %></textarea>
                </div>
                
                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="window.location.href='/trainer'">Cancel</button>
                    <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save Workout Plan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Exercise Selection Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Exercise</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-search">
                    <input type="text" id="exerciseSearch" placeholder="Search exercises...">
                </div>
                <div class="exercise-categories">
    <button class="category-btn active" data-category="all">All</button>
    <button class="category-btn" data-category="calisthenics">Calisthenics</button>
    <button class="category-btn" data-category="strength training">Strength Training</button>
    <button class="category-btn" data-category="hiit">HIIT</button>
    <button class="category-btn" data-category="cardio">Cardio</button>
    <button class="category-btn" data-category="bodybuilding">Bodybuilding</button>
    <button class="category-btn" data-category="weight loss">Weight Loss</button>
    <button class="category-btn" data-category="flexibility">Flexibility</button>
    <button class="category-btn" data-category="competitive">Competitive</button>
</div>
                <div class="exercise-list">
                    <div class="exercise-grid" id="exerciseGrid">
                        <!-- Dynamic exercises from database -->
                        <% if (exercises && exercises.length > 0) { %>
                            <% exercises.forEach(exercise => { %>
                                <div class="exercise-select-item" 
                                     data-name="<%= exercise.name %>" 
                                     data-category="<%= exercise.category.toLowerCase() %>"
                                     data-sets="<%= exercise.defaultSets %>"
                                     data-reps="<%= exercise.defaultRepsOrDuration %>">
                                    <div class="exercise-select-name"><%= exercise.name %></div>
                                    <div class="exercise-select-target"><%= exercise.category %></div>
                                    <div class="exercise-select-details">
                                        <%= exercise.defaultSets %> sets × <%= exercise.defaultRepsOrDuration %>
                                        <% if (exercise.targetMuscles && exercise.targetMuscles.length > 0) { %>
                                            <br><small>Target: <%= exercise.targetMuscles.slice(0, 2).join(', ') %></small>
                                        <% } %>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="no-exercises">No exercises available in the database.</div>
                        <% } %>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="selectExerciseBtn" class="select-btn">Add Selected Exercise</button>
            </div>
        </div>
    </div>

    <!-- Success Message Toast -->
    <div id="successToast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span>Workout plan successfully saved!</span>
        </div>
    </div>

    <script>
        // Mobile menu functionality
        document.getElementById('menuIcon').addEventListener('click', function() {
            document.getElementById('sideNavbar').style.width = '250px';
        });
        
        document.getElementById('closeBtn').addEventListener('click', function() {
            document.getElementById('sideNavbar').style.width = '0';
        });

        // Current selected day for adding exercises
        let currentSelectedDay = 0;
        
        // Modal functionality
        const modal = document.getElementById('exerciseModal');
        const closeModal = document.querySelector('.close-modal');
        const selectExerciseBtn = document.getElementById('selectExerciseBtn');
        
        // Function to attach event listeners to dynamically created elements
        function attachEventListeners() {
            // Add exercise button click handler
            document.querySelectorAll('.add-exercise-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentSelectedDay = this.getAttribute('data-day');
                    modal.style.display = 'block';
                });
            });
            
            // Rest day button functionality
            document.querySelectorAll('.rest-day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dayIndex = this.getAttribute('data-day');
                    const dayContainer = document.getElementById(`exercises-day-${dayIndex}`);
                    
                    // Clear all exercises
                    dayContainer.innerHTML = '';
                    
                    // Add rest day message
                    const restDayDiv = document.createElement('div');
                    restDayDiv.className = 'rest-day-message';
                    restDayDiv.innerHTML = '<i class="fas fa-moon"></i> Rest Day';
                    dayContainer.appendChild(restDayDiv);
                });
            });
            
            // Remove exercise button functionality
            document.querySelectorAll('.remove-exercise-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const exerciseItem = this.closest('.exercise-item');
                    const dayContainer = exerciseItem.closest('.exercises-list');
                    
                    dayContainer.removeChild(exerciseItem);
                    
                    // If no exercises left, add rest day message
                    if (dayContainer.querySelectorAll('.exercise-item').length === 0) {
                        const restDayDiv = document.createElement('div');
                        restDayDiv.className = 'rest-day-message';
                        restDayDiv.innerHTML = '<i class="fas fa-moon"></i> Rest Day';
                        dayContainer.appendChild(restDayDiv);
                    }
                });
            });
        }
        
        // Initial attachment of event listeners
        attachEventListeners();
        
        // Close modal when clicking the X
        closeModal.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Exercise selection
        const exerciseItems = document.querySelectorAll('.exercise-select-item');
        let selectedExercise = null;
        
        exerciseItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove selected class from all items
                exerciseItems.forEach(i => i.classList.remove('selected'));
                // Add selected class to clicked item
                this.classList.add('selected');
                selectedExercise = this.getAttribute('data-name');
            });
        });
        
        // Add selected exercise to the day with default values
        selectExerciseBtn.addEventListener('click', function() {
            if (selectedExercise) {
                const selectedExerciseElement = document.querySelector('.exercise-select-item.selected');
                const dayContainer = document.getElementById(`exercises-day-${currentSelectedDay}`);
                const dayName = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][currentSelectedDay];
                
                // Remove rest day message if it exists
                const restDayMsg = dayContainer.querySelector('.rest-day-message');
                if (restDayMsg) {
                    dayContainer.removeChild(restDayMsg);
                }
                
                // Get the number of existing exercises
                const existingExercises = dayContainer.querySelectorAll('.exercise-item');
                const exerciseIndex = existingExercises.length;
                
                // Get default values from the selected exercise
                const defaultSets = selectedExerciseElement.getAttribute('data-sets') || '3';
                const defaultReps = selectedExerciseElement.getAttribute('data-reps') || '10-12';
                
                // Create new exercise item with default values
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.innerHTML = `
                    <div class="exercise-details">
                        <input type="text" name="currentWeek[${dayName}][${exerciseIndex}][name]" class="exercise-name-input" value="${selectedExercise}" placeholder="Exercise name" readonly>
                        <div class="exercise-params">
                            <input type="text" name="currentWeek[${dayName}][${exerciseIndex}][sets]" class="sets-input" value="${defaultSets}" placeholder="Sets">
                            <input type="text" name="currentWeek[${dayName}][${exerciseIndex}][reps]" class="reps-input" value="${defaultReps}" placeholder="Reps">
                            <input type="text" name="currentWeek[${dayName}][${exerciseIndex}][weight]" class="weight-input" placeholder="Weight (kg)">
                        </div>
                    </div>
                    <button type="button" class="remove-exercise-btn"><i class="fas fa-trash"></i></button>
                `;
                
                // Add to day container
                dayContainer.appendChild(exerciseItem);
                
                // Add event listener to remove button
                const removeBtn = exerciseItem.querySelector('.remove-exercise-btn');
                removeBtn.addEventListener('click', function() {
                    dayContainer.removeChild(exerciseItem);
                    
                    // If no exercises left, add rest day message
                    if (dayContainer.querySelectorAll('.exercise-item').length === 0) {
                        const restDayDiv = document.createElement('div');
                        restDayDiv.className = 'rest-day-message';
                        restDayDiv.innerHTML = '<i class="fas fa-moon"></i> Rest Day';
                        dayContainer.appendChild(restDayDiv);
                    }
                });
                
                // Close modal
                modal.style.display = 'none';
                
                // Clear selection
                document.querySelectorAll('.exercise-select-item').forEach(i => i.classList.remove('selected'));
                selectedExercise = null;
            }
        });
        
        // Category filtering
        // Category filtering - UPDATED for exercise types
const categoryBtns = document.querySelectorAll('.category-btn');

categoryBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        
        // Update active button
        categoryBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Filter exercises
        exerciseItems.forEach(item => {
            if (category === 'all') {
                item.style.display = 'block';
            } else {
                const itemCategory = item.getAttribute('data-category');
                // Handle case-insensitive matching
                if (itemCategory && itemCategory.toLowerCase() === category.toLowerCase()) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            }
        });
    });
});
        
        // Exercise search functionality
        const exerciseSearch = document.getElementById('exerciseSearch');
        
        exerciseSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            exerciseItems.forEach(item => {
                const exerciseName = item.getAttribute('data-name').toLowerCase();
                
                if (exerciseName.includes(searchTerm)) {
                    // Only show if it also passes the category filter
                    const activeCategory = document.querySelector('.category-btn.active').getAttribute('data-category');
                    const itemCategory = item.getAttribute('data-category');
                    
                    if (activeCategory === 'all' || activeCategory === itemCategory) {
                        item.style.display = 'block';
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Form submission
        // Form submission - FIXED VERSION
const workoutPlanForm = document.getElementById('workoutPlanForm');

workoutPlanForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Prepare data structure for current week only
    const workoutData = {
        clientId: document.getElementById('clientId').value,
        notes: document.getElementById('plan-notes').value,
        currentWeek: {}
    };

    // Process current week data
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    days.forEach((day, index) => {
        const dayContainer = document.getElementById(`exercises-day-${index}`);
        if (!dayContainer) return;
        
        const exerciseItems = dayContainer.querySelectorAll('.exercise-item');
        workoutData.currentWeek[day] = [];
        
        exerciseItems.forEach(item => {
            const nameInput = item.querySelector('input.exercise-name-input');
            const setsInput = item.querySelector('input.sets-input');
            const repsInput = item.querySelector('input.reps-input');
            const weightInput = item.querySelector('input.weight-input');
            
            if (nameInput && nameInput.value) {
                const exerciseData = {
                    name: nameInput.value,
                    day: day
                };
                
                // Only add fields that have actual values
                if (setsInput && setsInput.value && setsInput.value.trim() !== '') {
                    exerciseData.sets = setsInput.value;
                }
                if (repsInput && repsInput.value && repsInput.value.trim() !== '') {
                    exerciseData.reps = repsInput.value;
                }
                if (weightInput && weightInput.value && weightInput.value.trim() !== '') {
                    exerciseData.weight = weightInput.value;
                }
                
                workoutData.currentWeek[day].push(exerciseData);
            }
        });
    });

    //  console.log('Sending workout data:', workoutData);

    // Send data to server via fetch API
    fetch('/save-workout-plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(workoutData)
    })
    .then(response => response.json())
    .then(data => {
        //  console.log('Success:', data);
        
        // Show success message
        const successToast = document.getElementById('successToast');
        successToast.classList.add('show');
        
        // Hide toast after 3 seconds
        setTimeout(() => {
            successToast.classList.remove('show');
            // FIX: Use the redirect URL from server response instead of hardcoding
            if (data.redirect) {
                window.location.href = data.redirect; // This will include the clientId
            } else {
                // Fallback to hardcoded URL if no redirect provided
                window.location.href = '/trainer';
            }
        }, 3000);
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('There was an error saving the workout plan.');
    });
});

    </script>
</body>
</html>